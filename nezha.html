<script>
	// åˆå¹¶nezhaä¸»é¢˜é…ç½®
	window.$mergeNazhuaConfig && window.$mergeNazhuaConfig({
		homeWorldMapPosition: "bottom",
		detailWorldMapPosition: 'bottom',
		hideDetailWorldMap: false,
		enableInnerSearch: false,
		listServerItemType: 'card',
		simpleColorMode: true,
		hideListItemStatusDonut: false,
		lightBackground: true,
		hideFilter: true,
		customBackgroundImage: "https://static.08310507.xyz/bg1.png"
	})
	// æœåŠ¡å™¨ä¿¡æ¯
	window.__ServerInfo = [
		{
			id: 1,
			name: 'æœåŠ¡A',
			billing: {
				startDate: '2025-05-14',
				endDate: '2025-06-14',
				month: true,
				amount: 2.63
			},
			bandwidth: 200,
			trafficVol: 2000,
			ipCheckReportHash: [
				'3FL480GSY'
			]
		},
		{
			id: 13,
			name: 'æœåŠ¡B',
			billing: {
				startDate: '2025-05-14',
				endDate: '2025-06-14',
				year: true,
				amount: 6
			},
			bandwidth: 1000,
			trafficVol: 2000,
			ipCheckReportHash: [
				'36Z23PMVB'
			]
		}
	]
</script>

<!-- åŠ è½½tailwindcss -->
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

<!-- è´¦å•ä¿¡æ¯æ¨¡æ¿ -->
<template id="billing-info-template">
	<div class="w-full cursor-default">
		<!-- é¡¶éƒ¨ï¼šä»·æ ¼å’Œå‰©ä½™æ—¶é—´ -->
		<div class="flex items-center justify-between mb-3">
			<!-- å‰©ä½™æ—¶é—´ -->
			<div class="flex items-center gap-1.5 text-sm text-gray-400"
				 :title="billing.startDate + ' - ' + billing.endDate">
				<i class="ri-hourglass-fill text-blue-400"></i>
				<span>å‰©ä½™</span>
				<span class="font-semibold">{{ calculateRemainingDays(billing) }}</span>
				<span class="text-xs text-gray-500" v-if="billing.endDate">ï¼ˆ{{ billing.startDate }} - {{ billing.endDate }}ï¼‰</span>
				<span class="text-xs text-gray-500" v-else>ï¼ˆ{{ billing.startDate }}è´­å…¥ï¼‰</span>
			</div>
			<!-- ä»·æ ¼ -->
			<div class="flex items-center gap-2">
				<div class="flex items-center">
					<div class="text-lg font-bold text-gray-400 cursor-pointer hover:text-white hover:underline"
						 @click="togglePriceType">
						{{ price }}
					</div>
					<span class="text-lg font-bold text-gray-500">/</span>
					<div class="text-lg font-bold text-gray-400 cursor-pointer hover:text-white hover:underline"
						 @click="toggleCycle">
						{{ cycle }}
					</div>
				</div>
				<div v-if="info.billing.month"
					 class="px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded-full border border-green-500/30">
					æœˆä»˜
				</div>
				<div v-if="info.billing.year"
					 class="px-2 py-0.5 bg-yellow-500/20 text-yellow-400 text-xs rounded-full border border-yellow-500/30">
					å¹´ä»˜
				</div>
			</div>
		</div>
		<!-- åº•éƒ¨ï¼šé…ç½®ä¿¡æ¯ç½‘æ ¼ -->
		<div class="grid grid-cols-2 gap-2">
			<!-- å¸¦å®½ -->
			<div class="flex items-center gap-2 px-2 py-1.5 bg-white/5 rounded-md">
				<i class="ri-speed-line text-blue-400 text-sm"></i>
				<div class="flex flex-col text-gray-400">
					<span class="text-xs">å¸¦å®½</span>
					<span class="text-sm font-medium">{{ bandwidth() }}</span>
				</div>
			</div>
			<!-- æµé‡ -->
			<div class="flex items-center gap-2 px-2 py-1.5 bg-white/5 rounded-md">
				<i class="ri-database-line text-green-400 text-sm"></i>
				<div class="flex flex-col text-gray-400">
					<span class="text-xs">æµé‡</span>
					<span class="text-sm font-medium">{{ trafficVol() }}</span>
				</div>
			</div>
		</div>
	</div>
</template>

<!-- è´¦å•ä¿¡æ¯ç»„ä»¶ -->
<script type="module">
	function registerBillingComponent(app, element, emitter, exchangeRateMap) {
		const { ref, computed, onMounted, onUnmounted, nextTick } = Vue
		app.component('billing-info', {
			template: document.getElementById('billing-info-template').innerHTML,
			props: {
				server: { type: Object, required: true },
				info: { type: Object, required: true }
			},
			setup(props) {
				const priceType = ref('$')
				const cycle = ref('Monthly')
				const price = computed(() => {
					if (props.info.billing.free) {
						return 'å…è´¹'
					}
					let amount = 0
					if (priceType.value === '$') {
						amount = props.info.billing.amount
					} else {
						const cny = exchangeRateMap ? exchangeRateMap['cny'] : 7.2
						amount = props.info.billing.amount * cny
					}
					if (cycle.value === 'Yearly') {
						amount = amount * 12
					}
					return `${amount.toFixed(2)}${priceType.value}`
				})
				emitter.on('change-price-type', props.info.id, (v) => {
					priceType.value = v
				})
				emitter.on('change-cycle', props.info.id, (v) => {
					cycle.value = v
				})
				return {
					billing: props.info.billing,
					price,
					cycle,
					togglePriceType() {
						priceType.value = priceType.value === '$' ? 'ï¿¥' : '$'
						emitter.emit('change-price-type', priceType.value)
					},
					toggleCycle() {
						cycle.value = cycle.value === 'Monthly' ? 'Yearly' : 'Monthly'
						emitter.emit('change-cycle', cycle.value)
					},
					bandwidth() {
						if (props.info.bandwidth) {
							if (props.info.bandwidth > 1000) {
								return (props.info.bandwidth / 1000).toFixed(2) + 'Gbps'
							}
							return props.info.bandwidth + 'Mbps'
						}
						return props.info.bandwidth || 'æœªçŸ¥'
					},
					trafficVol() {
						if (props.info.trafficVol) {
							if (props.info.trafficVol > 1000) {
								return (props.info.trafficVol / 1000).toFixed(2) + 'TB'
							}
							return props.info.trafficVol + 'GB'
						}
						return props.info.trafficVol || 'âˆ'
					},
					calculateRemainingDays() {
						const billing = props.info?.billing
						if (!billing) {
							return 'æœªçŸ¥'
						}
						if (!billing.endDate) {
							return 'é•¿æœŸæœ‰æ•ˆ'
						}
						const end = new Date(billing.endDate + ' 23:59:59')
						if (isNaN(end.getTime())) {
							return billing.endDate
						}
						const now = new Date()
						const diffTime = end - now
						const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24))
						return Math.max(0, diffDays) + 'å¤©'
					}
				}
			}
		})
	}
	window.registerBillingComponent = registerBillingComponent
</script>

<!-- å»¶è¿Ÿç›‘æ§ç»Ÿè®¡æ¨¡æ¿ -->
<template id="latency-monitor-template">
	<div class="w-full">
		<div v-if="loading" class="p-5 text-gray-400 text-sm text-center bg-white/5 rounded-lg">
			æ­£åœ¨åŠ è½½å»¶è¿Ÿç›‘æ§æ•°æ®...
		</div>
		<div v-else-if="error" class="p-5 text-red-400 text-sm text-center bg-red-500/10 rounded-lg"
			 @click="forceReloadData">
			å»¶è¿Ÿç›‘æ§æ•°æ®åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•
		</div>
		<!-- Monitor Content -->
		<div v-else-if="monitorData && monitorData.length > 0">
			<!-- Monitor Stats Grid -->
			<div class="space-y-3">
				<div v-for="monitor in processedData" :key="monitor.monitor_id" class="p-1">
					<div class="flex items-center justify-between mb-2">
						<div class="font-medium text-gray-300 flex items-center gap-2">
							<i class="ri-radar-line text-blue-400 text-sm"></i>
							{{ monitor.monitor_name }}
						</div>
						<div class="text-xs text-gray-500">
							{{ monitor.dataPoints }} ä¸ªæ•°æ®ç‚¹
						</div>
					</div>
					<!-- Stats Grid -->
					<div class="grid grid-cols-2 lg:grid-cols-6 gap-2">
						<!-- å¹³å‡å»¶è¿Ÿ -->
						<div class="flex flex-col items-center p-2 bg-white/5 rounded-md cursor-help"
							 :title="getAverageLatencyTooltip(monitor)">
							<span class="text-xs text-gray-400 mb-1">å¹³å‡å»¶è¿Ÿ</span>
							<span class="text-sm font-semibold text-blue-400">
								{{ monitor.avgLatency }}ms
							</span>
						</div>
						<!-- ä¸¢åŒ…ç‡ -->
						<div class="flex flex-col items-center p-2 bg-white/5 rounded-md cursor-help"
							 :title="getPacketLossTooltip(monitor)"
							 :class="monitor.packetLoss > 5 ? 'text-red-400 font-semibold' : monitor.packetLoss > 1 ? 'text-yellow-400' : 'text-green-400'">
							<span class="text-xs text-gray-400 mb-1">ä¸¢åŒ…ç‡</span>
							<span class="text-sm font-semibold"
								  :class="monitor.packetLoss > 5 ? 'text-red-400' : monitor.packetLoss > 1 ? 'text-yellow-400' : 'text-green-400'">
								{{ monitor.packetLoss }}%
							</span>
						</div>
						<!-- æœ€å°å»¶è¿Ÿ -->
						<div class="flex flex-col items-center p-2 bg-white/5 rounded-md cursor-help"
							 :title="getMinLatencyTooltip(monitor)">
							<span class="text-xs text-gray-400 mb-1">æœ€å°å»¶è¿Ÿ</span>
							<span class="text-sm font-semibold text-green-400">
								{{ monitor.minLatency }}ms
							</span>
						</div>
						<!-- æœ€å¤§å»¶è¿Ÿ -->
						<div class="flex flex-col items-center p-2 bg-white/5 rounded-md cursor-help"
							 :title="getMaxLatencyTooltip(monitor)">
							<span class="text-xs text-gray-400 mb-1">æœ€å¤§å»¶è¿Ÿ</span>
							<span class="text-sm font-semibold text-red-400">
								{{ monitor.maxLatency }}ms
							</span>
						</div>
						<!-- å»¶è¿Ÿä¸­ä½æ•° -->
						<div class="flex flex-col items-center p-2 bg-white/5 rounded-md cursor-help"
							 :title="getMedianLatencyTooltip(monitor)">
							<span class="text-xs text-gray-400 mb-1">å»¶è¿Ÿä¸­ä½æ•°</span>
							<span class="text-sm font-semibold text-purple-400">
								{{ monitor.medianLatency }}ms
							</span>
						</div>
						<!-- ç½‘ç»œæŠ–åŠ¨ -->
						<div class="flex flex-col items-center p-2 bg-white/5 rounded-md cursor-help"
							 :title="getJitterTooltip(monitor)">
							<span class="text-xs text-gray-400 mb-1">ç½‘ç»œæŠ–åŠ¨</span>
							<span class="text-sm font-semibold text-orange-400">
								{{ monitor.jitter }}ms
							</span>
						</div>
					</div>
					<!-- Network Quality and Stability -->
					<div class="mt-3 flex items-center justify-between">
						<div class="flex items-center gap-3">
							<div class="flex items-center gap-2">
								<span class="text-xs text-gray-400">ç½‘ç»œè´¨é‡:</span>
								<span class="px-2 py-1 rounded-md text-xs font-medium shadow-sm shadow-black/30 cursor-help"
									  :class="getQualityClass(monitor.qualityScore)"
									  :title="getQualityTooltip(monitor)">
									{{ getQualityLabel(monitor.qualityScore) }}
								</span>
								<span class="text-xs text-gray-500" v-if="monitor.hasEnoughData">
									({{ monitor.qualityScore }}åˆ†)
								</span>
							</div>
							<div v-if="monitor.hasEnoughData" class="flex items-center gap-2">
								<span class="text-xs text-gray-400">ç¨³å®šæ€§:</span>
								<span class="text-xs font-medium cursor-help" :class="monitor.stabilityScore >= 90 ? 'text-green-400' : 
											  monitor.stabilityScore >= 80 ? 'text-yellow-400' : 'text-red-400'" :title="getStabilityTooltip(monitor)">
									{{ monitor.stabilityScore }}åˆ†
								</span>
							</div>
						</div>
						<div v-if="monitor.hasEnoughData" class="text-xs text-gray-500 cursor-help"
							 :title="getAbnormalRateTooltip(monitor)">
							å¼‚å¸¸æ³¢åŠ¨: {{ monitor.abnormalRate }}%
						</div>
					</div>
				</div>
			</div>
			<!-- æ—¶é—´èŒƒå›´æ˜¾ç¤º -->
			<div v-if="dataTimeRange" class="my-2 text-xs text-gray-500 text-center">
				æ•°æ®æ—¶é—´èŒƒå›´: {{ dataTimeRange }}
			</div>
		</div>
		<!-- No Data -->
		<div v-else class="p-5 text-gray-400 text-sm text-center bg-white/5 rounded-lg">
			æš‚æ— å»¶è¿Ÿç›‘æ§æ•°æ®
		</div>
	</div>
</template>

<!-- å»¶è¿Ÿç›‘æ§ç»Ÿè®¡ç»„ä»¶ -->
<script type="module">
	window.registerLatencyMonitorComponent = function (app, element, emitter) {
		const { ref, computed, onMounted, onUnmounted } = Vue
		app.component('latency-monitor', {
			template: document.getElementById('latency-monitor-template').innerHTML,
			props: {
				server: { type: Object, required: true },
				info: { type: Object, required: true }
			},
			setup(props) {
				const loading = ref(false)
				const error = ref(false)
				const monitorData = ref(null)

				const dataTimeRange = computed(() => {
					if (!monitorData.value || monitorData.value.length === 0) return ''
					const allTimestamps = monitorData.value.flatMap(m => m.created_at)
					if (allTimestamps.length === 0) return ''
					const earliest = Math.min(...allTimestamps)
					const latest = Math.max(...allTimestamps)
					const start = new Date(earliest).toLocaleString('zh-CN', {
						month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
					})
					const end = new Date(latest).toLocaleString('zh-CN', {
						month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
					})
					return `${start} - ${end}`
				})

				// è®¡ç®—æ ‡å‡†å·®
				const calculateStandardDeviation = (values, mean) => {
					const variance = values.reduce((sum, value) => sum + Math.pow(value - mean, 2), 0) / values.length
					return Math.sqrt(variance)
				}
				// è®¡ç®—ç½‘ç»œæŠ–åŠ¨
				const calculateJitter = (validDelays) => {
					if (validDelays.length < 2) return 0
					let totalJitter = 0
					for (let i = 1; i < validDelays.length; i++) {
						totalJitter += Math.abs(validDelays[i] - validDelays[i - 1])
					}
					return totalJitter / (validDelays.length - 1)
				}
				// è®¡ç®—ç¨³å®šæ€§è¯„åˆ†
				const calculateStabilityScore = (validDelays, avgLatency) => {
					if (validDelays.length < 10) return { score: 0, abnormalRate: 0, details: {} }
					const mean = parseFloat(avgLatency)
					const stdDev = calculateStandardDeviation(validDelays, mean)
					const minDelay = Math.min(...validDelays)
					const maxDelay = Math.max(...validDelays)
					const range = maxDelay - minDelay

					// è®¡ç®—å˜å¼‚ç³»æ•° (CV = æ ‡å‡†å·®/å¹³å‡å€¼)
					const coefficientOfVariation = stdDev / mean

					// è®¡ç®—å››åˆ†ä½è· (IQR)
					const sortedDelays = [...validDelays].sort((a, b) => a - b)
					const q1Index = Math.floor(sortedDelays.length * 0.25)
					const q3Index = Math.floor(sortedDelays.length * 0.75)
					const q1 = sortedDelays[q1Index]
					const q3 = sortedDelays[q3Index]
					const iqr = q3 - q1

					// æ™ºèƒ½å¼‚å¸¸é˜ˆå€¼è®¡ç®—
					let threshold
					let methodUsed

					// æ–¹æ³•1ï¼šå¯¹äºå˜åŒ–èŒƒå›´å¾ˆå°çš„ç¨³å®šç½‘ç»œï¼ˆèŒƒå›´<10msä¸”å˜å¼‚ç³»æ•°<0.1ï¼‰
					if (range < 10 && coefficientOfVariation < 0.1) {
						// ä½¿ç”¨æ›´å®½æ¾çš„é˜ˆå€¼ï¼šå¹³å‡å€¼ + 3ä¸ªæ ‡å‡†å·® æˆ–è€… Q3 + 1.5*IQRï¼Œå–è¾ƒå¤§è€…
						const method1 = mean + 3 * stdDev
						const method2 = q3 + 1.5 * iqr
						threshold = Math.max(method1, method2, mean + range * 0.8) // è‡³å°‘æ˜¯å¹³å‡å€¼+80%çš„èŒƒå›´
						methodUsed = "ç¨³å®šç½‘ç»œæ¨¡å¼"
					}
					// æ–¹æ³•2ï¼šå¯¹äºä¸­ç­‰å˜åŒ–çš„ç½‘ç»œï¼ˆèŒƒå›´10-50msæˆ–å˜å¼‚ç³»æ•°0.1-0.3ï¼‰
					else if (range <= 50 && coefficientOfVariation <= 0.3) {
						// ä½¿ç”¨å››åˆ†ä½è·æ–¹æ³•ï¼šQ3 + 1.5*IQR
						threshold = q3 + 1.5 * iqr
						methodUsed = "å››åˆ†ä½è·æ–¹æ³•"
					}
					// æ–¹æ³•3ï¼šå¯¹äºå˜åŒ–è¾ƒå¤§çš„ç½‘ç»œ
					else {
						// ä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•ï¼šå¹³å‡å€¼ + 2ä¸ªæ ‡å‡†å·®ï¼ˆæ¯”åŸæ¥çš„1ä¸ªæ ‡å‡†å·®æ›´å®½æ¾ï¼‰
						threshold = mean + 2 * stdDev
						methodUsed = "æ ‡å‡†å·®æ–¹æ³•(2Ïƒ)"
					}

					// è®¡ç®—å¼‚å¸¸åŒ…
					const abnormalPackets = validDelays.filter(delay => delay > threshold)
					const abnormalRate = (abnormalPackets.length / validDelays.length) * 100

					// è®¡ç®—è¿ç»­å¼‚å¸¸æƒ…å†µ
					let consecutiveAbnormal = 0
					let maxConsecutive = 0
					validDelays.forEach(delay => {
						if (delay > threshold) {
							consecutiveAbnormal++
							maxConsecutive = Math.max(maxConsecutive, consecutiveAbnormal)
						} else {
							consecutiveAbnormal = 0
						}
					})

					// æ”¹è¿›çš„ç¨³å®šæ€§è¯„åˆ†è®¡ç®—
					let stabilityScore

					// åŸºç¡€åˆ†æ•°ï¼šæ ¹æ®å˜å¼‚ç³»æ•°ç»™åˆ†
					let baseScore = 100
					if (coefficientOfVariation <= 0.02) {
						baseScore = 100 // å˜å¼‚ç³»æ•°â‰¤2%ï¼Œå®Œç¾ç¨³å®š
					} else if (coefficientOfVariation <= 0.05) {
						baseScore = 95 // å˜å¼‚ç³»æ•°â‰¤5%ï¼Œä¼˜ç§€ç¨³å®š
					} else if (coefficientOfVariation <= 0.1) {
						baseScore = 90 // å˜å¼‚ç³»æ•°â‰¤10%ï¼Œè‰¯å¥½ç¨³å®š
					} else if (coefficientOfVariation <= 0.2) {
						baseScore = 80 // å˜å¼‚ç³»æ•°â‰¤20%ï¼Œä¸­ç­‰ç¨³å®š
					} else {
						baseScore = 70 // å˜å¼‚ç³»æ•°>20%ï¼Œç¨³å®šæ€§ä¸€èˆ¬
					}

					// å¼‚å¸¸ç‡æ‰£åˆ†ï¼ˆæ›´æ¸©å’Œçš„æ‰£åˆ†ç­–ç•¥ï¼‰
					const abnormalPenalty = Math.min(20, abnormalRate * 0.5) // å¼‚å¸¸ç‡æƒ©ç½šå‡åŠï¼Œæœ€å¤šæ‰£20åˆ†

					// è¿ç»­å¼‚å¸¸æ‰£åˆ†ï¼ˆæ›´æ¸©å’Œçš„ç­–ç•¥ï¼‰
					const consecutivePenalty = Math.min(10, maxConsecutive * 1) // è¿ç»­å¼‚å¸¸æ¯æ¬¡æ‰£1åˆ†ï¼Œæœ€å¤šæ‰£10åˆ†

					// å»¶è¿ŸèŒƒå›´å¥–åŠ±ï¼šèŒƒå›´è¶Šå°å¥–åŠ±è¶Šå¤š
					let rangeBonus = 0
					if (range <= 5) {
						rangeBonus = 5 // èŒƒå›´â‰¤5msï¼Œå¥–åŠ±5åˆ†
					} else if (range <= 10) {
						rangeBonus = 3 // èŒƒå›´â‰¤10msï¼Œå¥–åŠ±3åˆ†
					} else if (range <= 20) {
						rangeBonus = 1 // èŒƒå›´â‰¤20msï¼Œå¥–åŠ±1åˆ†
					}

					stabilityScore = Math.max(0, Math.min(100, baseScore - abnormalPenalty - consecutivePenalty + rangeBonus))

					return {
						score: stabilityScore.toFixed(0),
						abnormalRate: abnormalRate.toFixed(1),
						details: {
							mean,
							stdDev,
							threshold,
							abnormalCount: abnormalPackets.length,
							maxConsecutive,
							consecutivePenalty,
							abnormalPenalty,
							rangeBonus,
							baseScore,
							coefficientOfVariation,
							range,
							iqr,
							q1,
							q3,
							methodUsed
						}
					}
				}
				// è®¡ç®—ç½‘ç»œè´¨é‡ç»¼åˆå¾—åˆ†
				const calculateQualityScore = (avgLatency, packetLoss, stabilityScore) => {
					// å»¶è¿Ÿå¾—åˆ† (0-100)
					const latencyScore = avgLatency <= 50 ? 100 :
						avgLatency <= 100 ? 90 :
							avgLatency <= 200 ? 70 :
								avgLatency <= 250 ? 50 : 30

					// ä¸¢åŒ…å¾—åˆ† (0-100)
					const lossScore = packetLoss === 0 ? 100 :
						packetLoss <= 0.5 ? 95 :
							packetLoss <= 1 ? 85 :
								packetLoss <= 2 ? 70 :
									packetLoss <= 5 ? 50 : 20

					// ç»¼åˆå¾—åˆ† = ä¸¢åŒ…40% + å»¶è¿Ÿ30% + ç¨³å®šæ€§30%
					const totalScore = (lossScore * 0.4 + latencyScore * 0.3 + parseFloat(stabilityScore) * 0.3)

					return {
						score: totalScore.toFixed(1),
						details: {
							latencyScore,
							lossScore,
							stabilityScore: parseFloat(stabilityScore)
						}
					}
				}

				const processedData = computed(() => {
					if (!monitorData.value) return []

					return monitorData.value.map(monitor => {
						const validDelays = monitor.avg_delay.filter(delay => delay > 0)
						const totalPoints = monitor.avg_delay.length
						const lostPackets = totalPoints - validDelays.length
						const packetLoss = totalPoints > 0 ? ((lostPackets / totalPoints) * 100).toFixed(2) : '0.00'

						// æ£€æŸ¥æ•°æ®æ˜¯å¦è¶³å¤Ÿï¼ˆè‡³å°‘60ä¸ªæ•°æ®ç‚¹ï¼Œçº¦30åˆ†é’Ÿï¼‰
						const hasEnoughData = totalPoints >= 60

						if (validDelays.length === 0) {
							return {
								...monitor,
								dataPoints: totalPoints,
								hasEnoughData,
								avgLatency: '0.00',
								minLatency: '0.00',
								maxLatency: '0.00',
								medianLatency: '0.00',
								jitter: '0.00',
								packetLoss,
								stabilityScore: '0',
								abnormalRate: '0.0',
								qualityScore: '0.0',
								rawValidDelays: validDelays,
								rawTotalPoints: totalPoints,
								rawLostPackets: lostPackets
							}
						}

						const avgLatency = (validDelays.reduce((sum, delay) => sum + delay, 0) / validDelays.length).toFixed(2)
						const minLatency = Math.min(...validDelays).toFixed(2)
						const maxLatency = Math.max(...validDelays).toFixed(2)

						// è®¡ç®—ä¸­ä½æ•°
						const sortedDelays = [...validDelays].sort((a, b) => a - b)
						const mid = Math.floor(sortedDelays.length / 2)
						const medianLatency = sortedDelays.length % 2 === 0
							? ((sortedDelays[mid - 1] + sortedDelays[mid]) / 2).toFixed(2)
							: sortedDelays[mid].toFixed(2)

						// è®¡ç®—ç½‘ç»œæŠ–åŠ¨
						const jitter = calculateJitter(validDelays).toFixed(2)

						// è®¡ç®—ç¨³å®šæ€§è¯„åˆ†ï¼ˆä»…åœ¨æ•°æ®è¶³å¤Ÿæ—¶ï¼‰
						let stabilityResult = { score: '0', abnormalRate: '0.0', details: {} }
						if (hasEnoughData) {
							stabilityResult = calculateStabilityScore(validDelays, avgLatency)
						}

						// è®¡ç®—ç»¼åˆè´¨é‡å¾—åˆ†ï¼ˆä»…åœ¨æ•°æ®è¶³å¤Ÿæ—¶ï¼‰
						let qualityResult = { score: '0.0', details: {} }
						if (hasEnoughData) {
							qualityResult = calculateQualityScore(parseFloat(avgLatency), parseFloat(packetLoss), stabilityResult.score)
						}

						return {
							...monitor,
							dataPoints: totalPoints,
							hasEnoughData,
							avgLatency,
							minLatency,
							maxLatency,
							medianLatency,
							jitter,
							packetLoss,
							stabilityScore: stabilityResult.score,
							abnormalRate: stabilityResult.abnormalRate,
							qualityScore: qualityResult.score,
							rawValidDelays: validDelays,
							rawTotalPoints: totalPoints,
							rawLostPackets: lostPackets,
							stabilityDetails: stabilityResult.details,
							qualityDetails: qualityResult.details
						}
					}).sort((a, b) => a.monitor_name.localeCompare(b.monitor_name))
				})

				// Tooltipç”Ÿæˆå‡½æ•°
				const getAverageLatencyTooltip = (monitor) => {
					return `å¹³å‡å»¶è¿Ÿ: ${monitor.avgLatency}ms\n` +
						`è®¡ç®—æ–¹å¼: æ‰€æœ‰æœ‰æ•ˆå»¶è¿Ÿå€¼çš„ç®—æœ¯å¹³å‡æ•°\n` +
						`æœ‰æ•ˆæ•°æ®ç‚¹: ${monitor.rawValidDelays.length}ä¸ª\n` +
						`æ€»æ•°æ®ç‚¹: ${monitor.rawTotalPoints}ä¸ª`
				}

				const getPacketLossTooltip = (monitor) => {
					return `ä¸¢åŒ…ç‡: ${monitor.packetLoss}%\n` +
						`å…±ä¸¢åŒ…: ${monitor.rawLostPackets} æ¬¡\n` +
						`æœ‰æ•ˆå“åº”: ${monitor.rawValidDelays.length} æ¬¡\n` +
						`æ€»å‘é€: ${monitor.rawTotalPoints} æ¬¡\n` +
						`è®¡ç®—æ–¹å¼: (ä¸¢åŒ…æ¬¡æ•° Ã· æ€»å‘é€æ¬¡æ•°) Ã— 100%`
				}

				const getMinLatencyTooltip = (monitor) => {
					const minLatency = parseFloat(monitor.minLatency)
					const threshold = 10 // é˜ˆå€¼10ms
					const rangeMin = minLatency
					const rangeMax = minLatency + threshold
					const inRangeCount = monitor.rawValidDelays.filter(delay =>
						delay >= rangeMin && delay <= rangeMax
					).length

					return `æœ€å°å»¶è¿Ÿ: ${monitor.minLatency}ms\n` +
						`è¿™æ˜¯æ‰€æœ‰æœ‰æ•ˆæµ‹è¯•ä¸­çš„æœ€ä½å»¶è¿Ÿå€¼\n` +
						`åœ¨ ${rangeMin.toFixed(1)}ms - ${rangeMax.toFixed(1)}ms èŒƒå›´å†…: ${inRangeCount} æ¬¡\n` +
						`å æœ‰æ•ˆæµ‹è¯•çš„ ${((inRangeCount / monitor.rawValidDelays.length) * 100).toFixed(1)}%`
				}

				const getMaxLatencyTooltip = (monitor) => {
					const maxLatency = parseFloat(monitor.maxLatency)
					const threshold = Math.max(20, maxLatency * 0.1) // é˜ˆå€¼ä¸ºæœ€å¤§å»¶è¿Ÿçš„10%æˆ–20ms
					const rangeMin = maxLatency - threshold
					const rangeMax = maxLatency
					const inRangeCount = monitor.rawValidDelays.filter(delay =>
						delay >= rangeMin && delay <= rangeMax
					).length

					return `æœ€å¤§å»¶è¿Ÿ: ${monitor.maxLatency}ms\n` +
						`è¿™æ˜¯æ‰€æœ‰æœ‰æ•ˆæµ‹è¯•ä¸­çš„æœ€é«˜å»¶è¿Ÿå€¼\n` +
						`åœ¨ ${rangeMin.toFixed(1)}ms - ${rangeMax.toFixed(1)}ms èŒƒå›´å†…: ${inRangeCount} æ¬¡\n` +
						`å æœ‰æ•ˆæµ‹è¯•çš„ ${((inRangeCount / monitor.rawValidDelays.length) * 100).toFixed(1)}%`
				}

				const getMedianLatencyTooltip = (monitor) => {
					const sortedDelays = [...monitor.rawValidDelays].sort((a, b) => a - b)
					const isEven = sortedDelays.length % 2 === 0
					const mid = Math.floor(sortedDelays.length / 2)

					let explanation = `å»¶è¿Ÿä¸­ä½æ•°: ${monitor.medianLatency}ms\n\n` +
						`ç®—æ³•è¯´æ˜:\n` +
						`1. å°†æ‰€æœ‰ ${sortedDelays.length} ä¸ªæœ‰æ•ˆå»¶è¿Ÿå€¼ä»å°åˆ°å¤§æ’åº\n`

					if (isEven) {
						explanation += `2. å› ä¸ºæœ‰å¶æ•°ä¸ªæ•°æ®ï¼Œå–ä¸­é—´ä¸¤ä¸ªå€¼çš„å¹³å‡æ•°\n` +
							`3. ç¬¬${mid}ä¸ªå€¼: ${sortedDelays[mid - 1].toFixed(2)}ms\n` +
							`4. ç¬¬${mid + 1}ä¸ªå€¼: ${sortedDelays[mid].toFixed(2)}ms\n` +
							`5. ä¸­ä½æ•° = (${sortedDelays[mid - 1].toFixed(2)} + ${sortedDelays[mid].toFixed(2)}) Ã· 2 = ${monitor.medianLatency}ms`
					} else {
						explanation += `2. å› ä¸ºæœ‰å¥‡æ•°ä¸ªæ•°æ®ï¼Œå–æ­£ä¸­é—´çš„å€¼\n` +
							`3. ç¬¬${mid + 1}ä¸ªå€¼: ${sortedDelays[mid].toFixed(2)}ms\n` +
							`4. ä¸­ä½æ•° = ${monitor.medianLatency}ms`
					}

					explanation += `\n\nä¸­ä½æ•°èƒ½æ›´å¥½åœ°åæ˜ ç½‘ç»œå»¶è¿Ÿçš„å…¸å‹æ°´å¹³ï¼Œä¸å—æç«¯å€¼å½±å“`

					return explanation
				}

				const getJitterTooltip = (monitor) => {
					return `ç½‘ç»œæŠ–åŠ¨: ${monitor.jitter}ms\n\n` +
						`ç®—æ³•è¯´æ˜:\n` +
						`1. è®¡ç®—ç›¸é‚»ä¸¤æ¬¡æµ‹è¯•å»¶è¿Ÿçš„å·®å€¼ç»å¯¹å€¼\n` +
						`2. å°†æ‰€æœ‰å·®å€¼ç›¸åŠ æ±‚å¹³å‡æ•°\n` +
						`3. å…¬å¼: Î£|å»¶è¿Ÿ[i] - å»¶è¿Ÿ[i-1]| Ã· (æµ‹è¯•æ¬¡æ•°-1)\n\n` +
						`æŠ–åŠ¨å€¼è¶Šå°è¯´æ˜ç½‘ç»œè¶Šç¨³å®š\n` +
						`< 10ms: ç¨³å®š  10-30ms: ä¸€èˆ¬  >30ms: ä¸ç¨³å®š`
				}

				const getQualityTooltip = (monitor) => {
					if (!monitor.hasEnoughData) {
						return `ç½‘ç»œè´¨é‡: æ•°æ®ä¸è¶³\néœ€è¦è‡³å°‘60ä¸ªæ•°æ®ç‚¹æ‰èƒ½å‡†ç¡®è¯„ä¼°`
					}

					const details = monitor.qualityDetails
					return `ç½‘ç»œè´¨é‡: ${getQualityLabel(monitor.qualityScore)} (${monitor.qualityScore}åˆ†)\n\n` +
						`è®¡ç®—æ–¹å¼:\n` +
						`1. å»¶è¿Ÿå¾—åˆ†: ${details.latencyScore}åˆ† (æƒé‡30%)\n` +
						`   - â‰¤50ms:100åˆ†  â‰¤100ms:90åˆ†  â‰¤200ms:70åˆ†  â‰¤250ms:50åˆ†  >250ms:30åˆ†\n` +
						`2. ä¸¢åŒ…å¾—åˆ†: ${details.lossScore}åˆ† (æƒé‡40%)\n` +
						`   - 0%:100åˆ†  â‰¤0.5%:95åˆ†  â‰¤1%:85åˆ†  â‰¤2%:70åˆ†  â‰¤5%:50åˆ†  >5%:20åˆ†\n` +
						`3. ç¨³å®šæ€§å¾—åˆ†: ${details.stabilityScore}åˆ† (æƒé‡30%)\n\n` +
						`ç»¼åˆå¾—åˆ† = ${details.lossScore} Ã— 0.4 + ${details.latencyScore} Ã— 0.3 + ${details.stabilityScore} Ã— 0.3 = ${monitor.qualityScore}åˆ†`
				}

				const getStabilityTooltip = (monitor) => {
					if (!monitor.hasEnoughData) {
						return `ç¨³å®šæ€§: æ•°æ®ä¸è¶³\néœ€è¦è‡³å°‘60ä¸ªæ•°æ®ç‚¹æ‰èƒ½å‡†ç¡®è¯„ä¼°`
					}

					const details = monitor.stabilityDetails
					return `ç¨³å®šæ€§: ${monitor.stabilityScore}åˆ†\n\n` +
						`è¯„ä¼°æ–¹æ³•: ${details.methodUsed}\n` +
						`è®¡ç®—è¿‡ç¨‹:\n` +
						`1. åŸºç¡€è¯„åˆ†: ${details.baseScore}åˆ† (åŸºäºå˜å¼‚ç³»æ•° ${(details.coefficientOfVariation * 100).toFixed(2)}%)\n` +
						`2. å»¶è¿ŸèŒƒå›´: ${details.range.toFixed(2)}ms (å¥–åŠ± ${details.rangeBonus}åˆ†)\n` +
						`3. å¼‚å¸¸é˜ˆå€¼: ${details.threshold.toFixed(2)}ms\n` +
						`4. å¼‚å¸¸åŒ…æ•°é‡: ${details.abnormalCount}ä¸ª (æ‰£åˆ† ${details.abnormalPenalty.toFixed(1)}åˆ†)\n` +
						`5. æœ€å¤§è¿ç»­å¼‚å¸¸: ${details.maxConsecutive}æ¬¡ (æ‰£åˆ† ${details.consecutivePenalty}åˆ†)\n\n` +
						`æœ€ç»ˆå¾—åˆ† = ${details.baseScore} + ${details.rangeBonus} - ${details.abnormalPenalty.toFixed(1)} - ${details.consecutivePenalty} = ${monitor.stabilityScore}åˆ†\n\n` +
						`å˜å¼‚ç³»æ•°è¶Šå°ã€å»¶è¿ŸèŒƒå›´è¶Šå°è¡¨ç¤ºç½‘ç»œè¶Šç¨³å®š`
				}

				const getAbnormalRateTooltip = (monitor) => {
					if (!monitor.hasEnoughData) {
						return `å¼‚å¸¸æ³¢åŠ¨: æ•°æ®ä¸è¶³`
					}

					const details = monitor.stabilityDetails
					return `å¼‚å¸¸æ³¢åŠ¨: ${monitor.abnormalRate}%\n\n` +
						`è¯„ä¼°æ–¹æ³•: ${details.methodUsed}\n` +
						`ç®—æ³•è¯´æ˜:\n` +
						`1. å¼‚å¸¸é˜ˆå€¼: ${details.threshold.toFixed(2)}ms\n` +
						`2. å»¶è¿ŸèŒƒå›´: ${details.range.toFixed(2)}ms\n` +
						`3. å˜å¼‚ç³»æ•°: ${(details.coefficientOfVariation * 100).toFixed(2)}%\n` +
						`4. å››åˆ†ä½è·: ${details.iqr.toFixed(2)}ms\n` +
						`5. è¶…è¿‡é˜ˆå€¼çš„åŒ…: ${details.abnormalCount}ä¸ª\n` +
						`6. å¼‚å¸¸ç‡ = ${details.abnormalCount} Ã· ${monitor.rawValidDelays.length} Ã— 100% = ${monitor.abnormalRate}%\n\n` +
						`æ™ºèƒ½é˜ˆå€¼ç¡®ä¿ç¨³å®šç½‘ç»œä¸ä¼šè¢«è¯¯åˆ¤ä¸ºå¼‚å¸¸`
				}

				const getLatencyData = async (force = false) => {
					loading.value = true
					error.value = false
					monitorData.value = null

					try {
						const serverId = props.server.ID
						const cacheKey = `__latency_monitor_cache_${serverId}`
						const cache = localStorage.getItem(cacheKey)

						if (cache && !force) {
							const cacheData = JSON.parse(cache)
							if (Date.now() - cacheData.timestamp < 5 * 60 * 1000) { // 5åˆ†é’Ÿç¼“å­˜
								monitorData.value = cacheData.data
								loading.value = false
								return
							}
						}

						const response = await fetch(`/api/v1/service/${serverId}`)
						if (!response.ok) {
							throw new Error('Network response was not ok')
						}

						const result = await response.json()
						if (result.success && result.data) {
							monitorData.value = result.data
							localStorage.setItem(cacheKey, JSON.stringify({
								timestamp: Date.now(),
								data: result.data
							}))
						} else {
							throw new Error('Invalid data format')
						}
					} catch (err) {
						console.error('Failed to fetch latency data:', err)
						error.value = true
					} finally {
						loading.value = false
					}
				}
				// æ ¹æ®è´¨é‡å¾—åˆ†è·å–æ ·å¼ç±»
				const getQualityClass = (qualityScore) => {
					const score = parseFloat(qualityScore)
					if (score >= 95) {
						return 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' // æåº¦ä¼˜ç§€
					} else if (score >= 85) {
						return 'bg-green-500/20 text-green-400 border border-green-500/30' // ä¼˜ç§€
					} else if (score >= 75) {
						return 'bg-lime-500/20 text-lime-400 border border-lime-500/30' // è‰¯å¥½
					} else if (score >= 65) {
						return 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30' // ä¸­ç­‰
					} else if (score >= 55) {
						return 'bg-orange-500/20 text-orange-400 border border-orange-500/30' // åå·®
					} else if (score >= 45) {
						return 'bg-red-400/20 text-red-400 border border-red-400/30' // è¾ƒå·®
					} else {
						return 'bg-red-600/20 text-red-300 border border-red-600/30' // æå·®
					}
				}
				// æ ¹æ®è´¨é‡å¾—åˆ†è·å–æ ‡ç­¾
				const getQualityLabel = (qualityScore) => {
					const score = parseFloat(qualityScore)
					if (score === 0) {
						return 'æ•°æ®ä¸è¶³' // æ•°æ®ä¸è¶³æ—¶æ˜¾ç¤º
					} else if (score >= 95) {
						return 'æåº¦ä¼˜ç§€'
					} else if (score >= 85) {
						return 'ä¼˜ç§€'
					} else if (score >= 75) {
						return 'è‰¯å¥½'
					} else if (score >= 65) {
						return 'ä¸­ç­‰'
					} else if (score >= 55) {
						return 'åå·®'
					} else if (score >= 45) {
						return 'è¾ƒå·®'
					} else {
						return 'æå·®'
					}
				}

				// ç›‘å¬åˆ·æ–°äº‹ä»¶
				emitter.on('refresh-latency', props.info.id, (id) => {
					if (id !== props.info.id) return
					getLatencyData(true)
				})

				onMounted(async () => {
					await getLatencyData()
				})
				return {
					monitorData,
					loading,
					error,
					dataTimeRange,
					processedData,
					getQualityClass,
					getQualityLabel,
					getAverageLatencyTooltip,
					getPacketLossTooltip,
					getMinLatencyTooltip,
					getMaxLatencyTooltip,
					getMedianLatencyTooltip,
					getJitterTooltip,
					getQualityTooltip,
					getStabilityTooltip,
					getAbnormalRateTooltip,
					forceReloadData: () => getLatencyData(true)
				}
			}
		})
	}
</script>


<!-- IPè´¨é‡æŠ¥å‘Šæ¨¡æ¿ -->
<template id="ip-quality-report-template">
	<div class="w-full">
		<div v-if="loading" class="p-5 text-gray-400 text-sm text-center bg-white/5 rounded-lg">
			æ­£åœ¨åŠ è½½IPè´¨é‡æŠ¥å‘Š...
		</div>
		<div v-else-if="error" class="p-5 text-red-400 text-sm text-center bg-red-500/10 rounded-lg"
			 @click="forceReloadReport">
			IPè´¨é‡æŠ¥å‘ŠåŠ è½½å¤±è´¥...
		</div>

		<!-- Report Content -->
		<div v-else-if="reportData">
			<!-- Basic Info -->
			<div class="mb-4">
				<div class="font-semibold text-gray-400 mb-2 flex items-center justify-between gap-1.5 pr-2">
					<span>ğŸ“ åŸºç¡€ä¿¡æ¯</span>
					<span class="font-mono text-blue-400 text-sm">{{ reportData.ip }}</span>
				</div>
				<div class="grid grid-cols-[repeat(auto-fit,minmax(200px,1fr))] gap-2 mb-3">
					<div v-for="item in basicInfo" :key="item.label"
						 class="flex justify-between px-3 py-1.5 bg-white/5 rounded-md">
						<span class="text-gray-400 font-medium">{{ item.label }}:</span>
						<span class="text-gray-400 font-semibold font-mono overflow-hidden text-ellipsis whitespace-nowrap flex-1 ml-2 text-right"
							  :class="item.url ? 'cursor-pointer hover:underline' : ''" @click="openURL(item.url)"
							  :title="item.value">
							{{ item.value }}
						</span>
					</div>
				</div>
			</div>

			<!-- IP Attributes -->
			<div v-if="reportData.ip_type_attr && reportData.ip_type_attr.length > 0" class="mb-4">
				<div class="font-semibold text-gray-400 mb-2 flex items-center gap-1.5">ğŸ¢ IPå±æ€§ç±»å‹</div>
				<table class="w-full border-collapse mb-3 bg-white/2 rounded-lg overflow-hidden">
					<thead>
						<tr>
							<th class="bg-white/10 text-gray-400 p-2 text-center font-semibold"></th>
							<th v-for="attr in reportData.ip_type_attr" :key="attr.name"
								class="bg-white/10 text-gray-400 p-2 text-center font-semibold">
								{{ attr.name }}
							</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td class="text-gray-300 font-medium text-left !pl-3 p-1.5 border-b border-white/5">ä½¿ç”¨ç±»å‹
							</td>
							<td v-for="attr in reportData.ip_type_attr" :key="attr.name"
								class="p-1.5 text-center border-b border-white/5">
								<span v-if="attr.use_type"
									  :class="['px-2 py-1 rounded-md font-medium text-gray-200 text-center text-sm shadow-sm shadow-black/30', getAttrClass(attr.use_type)]">
									{{ attr.use_type }}
								</span>
								<span v-else class="text-gray-400">-</span>
							</td>
						</tr>
						<tr>
							<td class="text-gray-300 font-medium text-left !pl-3 p-1.5 border-b border-white/5">å…¬å¸ç±»å‹
							</td>
							<td v-for="attr in reportData.ip_type_attr" :key="attr.name"
								class="p-1.5 text-center border-b border-white/5">
								<span v-if="attr.company_type"
									  :class="['px-2 py-1 rounded-md font-medium text-gray-200 text-center text-sm shadow-sm shadow-black/30', getAttrClass(attr.company_type)]">
									{{ attr.company_type }}
								</span>
								<span v-else class="text-gray-400">-</span>
							</td>
						</tr>
					</tbody>
				</table>
			</div>

			<!-- Risk Scores -->
			<div v-if="reportData.risk_score && reportData.risk_score.length > 0" class="mb-4">
				<div class="font-semibold text-gray-400 mb-2 flex items-center gap-1.5">âš ï¸ é£é™©è¯„åˆ†</div>
				<table class="w-full border-collapse mb-3 bg-white/2 rounded-lg overflow-hidden">
					<thead>
						<tr>
							<th class="bg-white/10 text-gray-400 p-2 text-left font-semibold">æ•°æ®åº“</th>
							<th class="bg-white/10 text-gray-400 p-2 text-center font-semibold">é£é™©ç­‰çº§</th>
						</tr>
					</thead>
					<tbody>
						<tr v-for="score in reportData.risk_score" :key="score.name">
							<td class="text-gray-300 font-medium text-left !pl-3 p-1.5 border-b border-white/5"
								:class="score.url ? 'cursor-pointer hover:text-blue-400 hover:underline' : ''"
								@click="score.url && openURL(score.url)">
								{{ score.name }}
							</td>
							<td class="p-1.5 text-center border-b border-white/5">
								<div class="flex items-center justify-center gap-2">
									<span :class="['text-sm font-bold', getRiskLevelClass(score)]">
										{{ score.code || 0 }}
									</span>
									<span
										  :class="['px-2 py-1 rounded-md font-medium text-sm shadow-sm shadow-black/30', getRiskLevelClass(score)]">
										{{ score.label }}
									</span>
								</div>
							</td>
						</tr>
					</tbody>
				</table>
			</div>

			<!-- Risk Factors Table -->
			<div v-if="reportData.risk_factors && reportData.risk_factors.length > 0" class="mb-4">
				<div class="font-semibold text-gray-400 mb-2 flex items-center gap-1.5">ğŸ” é£é™©å› å­æ£€æµ‹</div>
				<table class="w-full border-collapse mb-3 bg-white/2 rounded-lg overflow-hidden">
					<thead>
						<tr>
							<th class="bg-white/10 text-gray-400 p-2 text-center font-semibold">æ•°æ®åº“</th>
							<th class="bg-white/10 text-gray-400 p-2 text-center font-semibold">ä»£ç†</th>
							<th class="bg-white/10 text-gray-400 p-2 text-center font-semibold">Tor</th>
							<th class="bg-white/10 text-gray-400 p-2 text-center font-semibold">VPN</th>
							<th class="bg-white/10 text-gray-400 p-2 text-center font-semibold">æœåŠ¡å™¨</th>
							<th class="bg-white/10 text-gray-400 p-2 text-center font-semibold">æ»¥ç”¨</th>
							<th class="bg-white/10 text-gray-400 p-2 text-center font-semibold">æœºå™¨äºº</th>
						</tr>
					</thead>
					<tbody>
						<tr v-for="factor in reportData.risk_factors" :key="factor.name">
							<td class="text-gray-300 font-medium text-left !pl-3 p-1.5 border-b border-white/5">{{
								factor.name }}</td>
							<td
								:class="['p-1.5 text-center border-b border-white/5', factor.isProxy ? 'text-red-400 font-semibold' : 'text-green-500']">
								{{ factor.isProxy ? 'æ˜¯' : 'å¦' }}</td>
							<td
								:class="['p-1.5 text-center border-b border-white/5', factor.isTor ? 'text-red-400 font-semibold' : 'text-green-500']">
								{{ factor.isTor ? 'æ˜¯' : 'å¦' }}</td>
							<td
								:class="['p-1.5 text-center border-b border-white/5', factor.isVPN ? 'text-red-400 font-semibold' : 'text-green-500']">
								{{ factor.isVPN ? 'æ˜¯' : 'å¦' }}</td>
							<td
								:class="['p-1.5 text-center border-b border-white/5', factor.isServer ? 'text-red-400 font-semibold' : 'text-green-500']">
								{{ factor.isServer ? 'æ˜¯' : 'å¦' }}</td>
							<td
								:class="['p-1.5 text-center border-b border-white/5', factor.isAubse ? 'text-red-400 font-semibold' : 'text-green-500']">
								{{ factor.isAubse ? 'æ˜¯' : 'å¦' }}</td>
							<td
								:class="['p-1.5 text-center border-b border-white/5', factor.isRobot ? 'text-red-400 font-semibold' : 'text-green-500']">
								{{ factor.isRobot ? 'æ˜¯' : 'å¦' }}</td>
						</tr>
					</tbody>
				</table>
			</div>

			<!-- Stream Unlock -->
			<div v-if="reportData.stream_unlock && reportData.stream_unlock.length > 0" class="mb-4">
				<div class="font-semibold text-gray-400 mb-2 flex items-center gap-1.5">ğŸ¬ æµåª’ä½“è§£é”</div>
				<div class="grid grid-cols-2 space-y-1.5">
					<div v-for="stream in reportData.stream_unlock" :key="stream.name"
						 class="flex items-center justify-between p-2.5 bg-gradient-to-r from-white/8 to-white/4 rounded-lg border border-white/10 shadow-sm shadow-black/20 hover:from-white/12 hover:to-white/6 transition-all duration-200">
						<!-- å·¦ä¾§ï¼šå›¾æ ‡ + æœåŠ¡å -->
						<div class="flex items-center gap-2.5 min-w-0 flex-1">
							<img :src="getStreamIcon(stream.name)" :alt="stream.name"
								 class="w-6 h-6 object-contain rounded-sm flex-shrink-0"
								 onerror="this.style.display='none'">
							<span class="text-gray-300 font-medium truncate">{{ stream.name }}</span>
						</div>
						<!-- å³ä¾§ï¼šçŠ¶æ€ + è¯¦ç»†ä¿¡æ¯ -->
						<div class="flex items-center gap-2 flex-shrink-0">
							<!-- åŒºåŸŸå’Œæ–¹å¼ -->
							<div class="hidden sm:flex items-center gap-1.5 text-xs text-gray-400">
								<span v-if="stream.area && stream.area !== 'æœªçŸ¥'"
									  class="px-1.5 py-0.5 bg-white/10 rounded border border-white/20">
									{{ stream.area }}
								</span>
								<span v-if="stream.method && stream.method !== 'æœªçŸ¥'"
									  class="px-1.5 py-0.5 bg-white/10 rounded border border-white/20">
									{{ stream.method }}
								</span>
							</div>
							<!-- çŠ¶æ€æ ‡ç­¾ -->
							<span
								  :class="['px-2.5 py-1 rounded-md font-medium text-sm shadow-sm shadow-black/30 whitespace-nowrap', getStreamStatusClass(stream.service)]">
								{{ stream.service }}
							</span>
						</div>
					</div>
				</div>
			</div>

			<!-- Additional Info -->
			<div class="w-full">
				<div class="font-semibold text-gray-400 mb-2 flex items-center gap-1.5">ğŸ“§ é™„åŠ æ£€æµ‹</div>
				<div class="w-full flex gap-3 items-center">
					<div
						 class="w-1/4 p-3 bg-gradient-to-br from-white/10 to-white/5 rounded-lg border border-white/10 shadow-sm shadow-black/20">
						<div class="text-gray-300 font-medium mb-2 pb-1 border-b border-white/10">é‚®ä»¶ç«¯å£25</div>
						<div :class="['text-sm font-semibold px-2 py-1 rounded-md text-center w-[80px]',
							reportData.mail_25port === 'é˜»æ–­' ?
							'text-red-500' :
							'text-green-500']">
							{{ reportData.mail_25port || 'æœªçŸ¥' }}
						</div>
					</div>
					<div
						 class="flex-1 p-3 bg-gradient-to-br from-white/10 to-white/5 rounded-lg border border-white/10 shadow-sm shadow-black/20">
						<div class="text-gray-300 font-medium mb-2 pb-1 border-b border-white/10">IPé»‘åå•æ•°æ®åº“</div>
						<div v-if="reportData.ip_blacklist" class="flex items-center justify-between gap-2">
							<div v-for="item in blacklistItems" :key="item.key" class="flex items-center gap-1">
								<span class="text-gray-400 text-xs">{{ item.label }}</span>
								<div class="w-[50px] px-2 py-1 rounded-md text-gray-200 text-sm text-center shadow-sm shadow-black/30"
									 :class="item.colorClass">
									{{ reportData.ip_blacklist[item.key] }}
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</template>

<!-- IPè´¨é‡æŠ¥å‘Š -->
<script type="module">
	window.registerIPQualityComponent = function (app, element, emitter) {
		const { ref, computed, onMounted, onUnmounted, nextTick } = Vue
		app.component('ip-quality-report', {
			template: document.getElementById('ip-quality-report-template').innerHTML,
			props: {
				server: { type: Object, required: true },
				info: { type: Object, required: true }
			},
			setup(props) {
				const loading = ref(false)
				const error = ref(false)
				const reportData = ref(null)

				const info = props.info

				const basicInfo = computed(() => {
					if (!reportData.value) return []
					const data = reportData.value
					const hash = info.ipCheckReportHash[0]
					return [
						{ label: 'ASN', value: data.as, url: `https://bgp.he.net/${data.as}` },
						{ label: 'æŠ¥å‘Šæ—¶é—´', value: data.report_time, url: `https://report.check.place/ip/${hash}.svg` },
						{ label: 'è„šæœ¬ç‰ˆæœ¬', value: data.version, url: `https://github.com/xykt/IPQuality` },
						{ label: 'ç»„ç»‡', value: data.organization, url: `https://www.google.com/search?q=${data.organization}` },
						{ label: 'åŸå¸‚', value: data.city, url: `https://www.google.com/search?q=${data.city}` },
						{ label: 'ä½¿ç”¨åœ°å€', value: data.use_address },
						{ label: 'æ³¨å†Œåœ°å€', value: data.reg_address },
						{ label: 'æ—¶åŒº', value: data.time_zone }
					].filter(item => item.value)
				})

				const getReportData = async (force = false) => {
					loading.value = true
					error.value = false
					reportData.value = null
					try {
						const hash = info.ipCheckReportHash[0]
						const data = await fetchIPQualityReport(hash)
						if (!data) {
							error.value = true
							return
						}
						reportData.value = data
						const cpuMemGroup = element.querySelector('.custom-server-header-group')
						if (cpuMemGroup && reportData.value.ip_type) {
							const ipTypeEl = cpuMemGroup.querySelector('.ip-type')
							ipTypeEl && ipTypeEl.remove()

							cpuMemGroup.innerHTML = `${cpuMemGroup.innerHTML}
							<div class="ip-type px-3 py-1 rounded-lg font-semibold text-gray-200 shadow-md shadow-black/30 
								${reportData.value.ip_type === 'åŸç”ŸIP' ? ' bg-gradient-to-br from-green-500 to-green-600' : ' bg-gradient-to-br from-yellow-500 to-yellow-600'}">
								${reportData.value.ip_type}
							</div>`
						}
						const serverNameEl = element.querySelector('.server-name')
						if (serverNameEl) {

							let addr = ''
							if (data.city) {
								if (data.city === 'N/A') {
									const arr = data.use_address?.split(',')
									if (arr?.length) {
										addr = arr[0].replace(/\[(.*?)\]/, '')
									}
								} else {
									const arr = data.city.split(',')
									if (arr?.length >= 2) {
										addr = arr[1]
									} else if (arr?.length) {
										addr = arr[0]
									}
								}
							}
							serverNameEl.innerHTML = `${info.id}. ${info.name}${addr ? ' - ' + addr : ''}`
						}
					} catch (err) {
						error.value = true
					} finally {
						loading.value = false
					}
				}

				// ç›‘å¬åˆ·æ–°äº‹ä»¶
				emitter.on('refresh-ipquality', props.info.id, (id) => {
					if (id !== props.info.id) return
					getReportData(true)
				})

				onMounted(async () => getReportData())
				return {
					reportData,
					loading,
					error,
					basicInfo,
					getRiskLevelClass,
					getAttrClass,
					getStreamStatusClass,
					getStreamIcon,
					blacklistItems,
					forceReloadReport: () => getReportData(true),
					openURL: url => {
						window.open(url, '_blank')
					}
				}
			}
		})
	}

	const IPQualityReportBaseURL = 'https://ipq.08310507.xyz'
	const IconBaseURL = 'https://static.08310507.xyz'
	const blacklistItems = [
		{ label: 'æœ‰æ•ˆ', key: 'valid', colorClass: 'text-green-500' },
		{ label: 'æ­£å¸¸', key: 'normal', colorClass: 'text-blue-500' },
		{ label: 'æ ‡è®°', key: 'marked', colorClass: 'text-yellow-500' },
		{ label: 'é»‘åå•', key: 'blacklist', colorClass: 'text-red-500' }
	]

	function getAttrClass(type) {
		const redTypes = ['æœºæˆ¿', 'CDN', 'èœ˜è››']
		const greenTypes = ['ä½å®…', 'å®¶å®½', 'æ‰‹æœº', 'çº¿è·¯']
		const purpleTypes = ['æ•™è‚²', 'å›¾ä¹¦é¦†']
		const blueTypes = ['å•†ä¸š', 'é“¶è¡Œ']
		const yellowTypes = ['æ”¿åºœ', 'ç»„ç»‡', 'å†›é˜Ÿ', 'ä¿ç•™', 'å…¶ä»–']
		if (redTypes.includes(type)) return 'text-red-500'
		if (greenTypes.includes(type)) return 'text-green-500'
		if (purpleTypes.includes(type)) return 'text-purple-500'
		if (blueTypes.includes(type)) return 'text-blue-500'
		if (yellowTypes.includes(type)) return 'text-yellow-500'
		return 'text-sky-500'
	}

	function getStreamStatusClass(service) {
		if (['åŸç”Ÿ', 'è§£é”'].includes(service)) return 'text-green-500'
		if (['å±è”½', 'å¤±è´¥', 'ç¦ä¼šå‘˜', 'ä¸­å›½'].includes(service)) return 'text-red-500'
		if (['ä»…è‡ªåˆ¶', 'ä»…ç½‘é¡µ', 'ä»…APP', 'æœºæˆ¿', 'DNS', 'å¾…æ”¯æŒ'].includes(service))
			return 'text-yellow-500'
		return 'text-gray-500'
	}

	function getStreamIcon(name) {
		return `${IconBaseURL}/${name.toLowerCase()}.png`
	}

	// Fetch IP quality report
	async function fetchIPQualityReport(hash, force = false) {
		try {
			const cacheKey = '__ip_quality_report_cache_' + hash
			const cache = localStorage.getItem(cacheKey)
			if (cache && !force) {
				const cacheData = JSON.parse(cache)
				if (cacheData.hash === hash) {
					return cacheData.data
				}
			}
			const response = await fetch(`${IPQualityReportBaseURL}/?type=ip-check-report&hash=${hash}`)
			if (!response.ok) {
				throw new Error('Network response was not ok')
			}
			const data = await response.json()
			// è®¾ç½®é£é™©è¯„åˆ†URL
			for (const risk_score of data.risk_score) {
				risk_score.url = ''
				switch (risk_score.name.toLowerCase()) {
					case 'scamalytics':
						risk_score.url = `https://scamalytics.com/ip`
						break
					case 'ipapi':
						risk_score.url = `https://ipapi.com/ip_api.php`
						break
					case 'abuseipdb':
						risk_score.url = `https://abuseipdb.com/check`
						break
					case 'ipqs':
						//risk_score.url = `https://ipqualityscore.com/api/json/ip/lPnx5AhAUv4jgIFDXquYpe8CVBjmaTii/${data.ip}`
						break
					case 'cloudflare':
						risk_score.url = `https://ip.nodeget.com/json`
						break
					case 'dbip':
						risk_score.url = `https://db-ip.com`
						break
				}
			}
			localStorage.setItem(cacheKey, JSON.stringify({ hash, data }))
			return data
		} catch (err) {
			console.error('Failed to fetch IP quality report:', err)
			return null
		}
	}

	function getRiskLevelClass(riskScore) {
		const label = riskScore.label
		switch (label) {
			case 'æä½é£é™©':
			case 'ä½é£é™©':
				return 'text-green-500'
			case 'ä¸­é£é™©':
			case 'è¾ƒé«˜é£é™©':
			case 'å¯ç–‘IP':
				return 'text-yellow-500'
			case 'é«˜é£é™©':
			case 'å­˜åœ¨é£é™©':
				return 'text-red-500'
			case 'æé«˜é£é™©':
			case 'å»ºè®®å°ç¦':
				return 'text-red-600'
			default:
				return 'text-green-500'
		}
	}
</script>

<!-- æœåŠ¡å™¨è¯¦æƒ…é¢æ¿æ¨¡æ¿ -->
<template id="server-detail-panel-template">
	<div class="relative m-3 group" v-if="availableTabs.length > 0">
		<div class="custom-panel cursor-default p-4">
			<!-- è´¦å•ä¿¡æ¯ -->
			<div class="mb-4">
				<billing-info :server="server" :info="info"></billing-info>
			</div>
			<!-- Tab åˆ‡æ¢å™¨ -->
			<div class="flex justify-between items-center mb-4 pb-3 border-b-2 border-white/10">
				<div class="flex gap-2">
					<button v-for="tab in availableTabs" :key="tab.key" @click="switchTab(tab.key)" :class="['px-3 py-1.5 rounded-md text-sm font-medium',
						activeTab === tab.key 
						? 'bg-blue-500/20 text-blue-400 border border-blue-500/30' 
						: 'bg-white/5 text-gray-400 hover:bg-white/10 hover:text-gray-300']">
						<i :class="tab.icon" class="mr-1"></i>
						{{ tab.label }}
					</button>
				</div>
				<div class="text-sm text-gray-400 cursor-pointer hover:text-gray-300" title="åˆ·æ–°å½“å‰é¡µé¢"
					 @click="refreshActiveTab">
					<i class="ri-restart-line"></i>
				</div>
			</div>
			<!-- å†…å®¹åŒºåŸŸ -->
			<div ref="panelContent" @scroll="checkScrollbar" class="w-full overflow-y-auto"
				 :class="isExpanded ? 'max-h-none' : 'max-h-[300px]'">
				<!-- å»¶è¿Ÿç›‘æ§ -->
				<div v-show="activeTab === 'latency'" v-if="hasLatencyData">
					<latency-monitor :server="server" :info="info"></latency-monitor>
				</div>
				<!-- IPè´¨é‡æŠ¥å‘Š -->
				<div v-show="activeTab === 'ipquality'" v-if="hasIPReport">
					<ip-quality-report :server="server" :info="info"></ip-quality-report>
				</div>
			</div>
		</div>
		<!-- å±•å¼€/æ”¶èµ·æŒ‰é’® -->
		<div v-if="(hasScrollbar && !isExpanded && !scrollbarIsBottom) || isExpanded"
			 class="absolute bottom-0 left-0 right-0 py-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 bg-gradient-to-t from-black/70 to-black/10 pointer-events-none rounded-b-xl">
			<button @click="toggleExpand"
					class="w-full h-8 flex items-center justify-center bg-black/30 hover:bg-black/50 text-gray-300 transition-all duration-200 rounded-md cursor-pointer pointer-events-auto">
				<span v-if="isExpanded">æ”¶èµ·å†…å®¹</span>
				<span v-else>å±•å¼€å…¨éƒ¨</span>
				<i :class="[isExpanded ? 'ri-arrow-up-line' : 'ri-arrow-down-line']"></i>
			</button>
		</div>
	</div>
</template>

<!-- æœåŠ¡å™¨è¯¦æƒ…é¢æ¿ç»„ä»¶ -->
<script type="module">
	window.registerServerDetailPanelComponent = function (app, element, emitter) {
		const { ref, computed, onMounted, nextTick } = Vue
		app.component('server-detail-panel', {
			template: document.getElementById('server-detail-panel-template').innerHTML,
			props: {
				server: { type: Object, required: true },
				info: { type: Object, required: true }
			},
			setup(props) {
				const panelContent = ref(null)
				const hasScrollbar = ref(false)
				const isExpanded = ref(false)
				const scrollbarIsBottom = ref(false)
				const activeTab = ref('')
				// æ£€æŸ¥å„ç»„ä»¶çš„å¯ç”¨æ€§
				const hasBilling = computed(() => !!props.info.billing)
				const hasLatencyData = computed(() => true)
				const hasIPReport = computed(() => props.info.ipCheckReportHash?.length > 0)
				// æ‰€æœ‰å¯èƒ½çš„tabå®šä¹‰
				const allTabs = [
					{ key: 'latency', label: 'å»¶è¿Ÿç›‘æ§', icon: 'ri-pulse-line', condition: hasLatencyData },
					{ key: 'ipquality', label: 'IPè´¨é‡', icon: 'ri-shield-check-line', condition: hasIPReport }
				]
				// å¯ç”¨çš„tabs
				const availableTabs = computed(() => allTabs.filter(tab => tab.condition.value))
				// è®¾ç½®é»˜è®¤æ´»è·ƒtab
				const initializeActiveTab = () => {
					if (availableTabs.value.length > 0) {
						activeTab.value = availableTabs.value[0].key
					}
				}
				// ç›‘å¬å…¨å±€tabåˆ‡æ¢äº‹ä»¶
				emitter.on('change-active-tab', props.info.id, (newTab) => {
					// åªæœ‰å½“å‰é¢æ¿æœ‰è¿™ä¸ªtabæ—¶æ‰åˆ‡æ¢
					if (availableTabs.value.some(tab => tab.key === newTab)) {
						activeTab.value = newTab
						nextTick(() => {
							checkScrollbar()
						})
					}
				})
				// åˆ‡æ¢tab
				const switchTab = (tabKey) => {
					activeTab.value = tabKey
					// å¹¿æ’­ç»™æ‰€æœ‰é¢æ¿
					emitter.emit('change-active-tab', tabKey)
					nextTick(() => {
						checkScrollbar()
					})
				}
				let lastScrollTop = 0
				// åˆ‡æ¢å±•å¼€/æ”¶èµ·çŠ¶æ€
				const toggleExpand = () => {
					if (!isExpanded.value) {
						lastScrollTop = document.documentElement.scrollTop
					}
					isExpanded.value = !isExpanded.value
					nextTick(() => {
						if (!isExpanded.value) {
							document.documentElement.scrollTo(0, lastScrollTop)
						}
						checkScrollbar()
					})
				}
				// æ£€æµ‹æ˜¯å¦æœ‰æ»šåŠ¨æ¡
				const checkScrollbar = () => {
					if (!panelContent.value) return
					const element = panelContent.value
					hasScrollbar.value = element.scrollHeight > element.clientHeight
					scrollbarIsBottom.value = Math.abs(element.scrollHeight - (element.scrollTop + element.clientHeight)) < 10
						|| element.scrollHeight === element.clientHeight
				}
				// åˆ·æ–°å½“å‰æ´»è·ƒçš„tab
				const refreshActiveTab = () => {
					switch (activeTab.value) {
						case 'latency':
							emitter.emit('refresh-latency', props.info.id)
							break
						case 'ipquality':
							emitter.emit('refresh-ipquality', props.info.id)
							break
					}
				}
				onMounted(() => {
					initializeActiveTab()
					window.addEventListener('resize', checkScrollbar)
					nextTick(() => setTimeout(checkScrollbar, 200))
				})
				return {
					panelContent,
					hasScrollbar,
					isExpanded,
					scrollbarIsBottom,
					activeTab,
					availableTabs,
					hasBilling,
					hasLatencyData,
					hasIPReport,
					switchTab, // ä½¿ç”¨æ–°çš„switchTabæ–¹æ³•
					toggleExpand,
					checkScrollbar,
					refreshActiveTab
				}
			}
		})
	}
</script>

<template id="custom-server-display-template">
	<server-detail-panel :server="server" :info="info"></server-detail-panel>
</template>

<script type="module">
	// @ts-nocheck
	// hook vuex store
	function hookStore(action, cb) {
		const old = document.querySelector('#app').__vue_app__._context.provides.store._mutations[action][0]
		document.querySelector('#app').__vue_app__._context.provides.store._mutations[action][0] = function (servers) {
			if (cb(servers, old)) return
			old(servers)
		}
	}

	// ws æ”¶åˆ°æ›´æ–°æ¶ˆæ¯ä¼šè°ƒç”¨æ­¤å‡½æ•°ï¼Œhook
	hookStore('UPDATE_SERVERS', (servers, old) => {
		old(servers)
		setTimeout(() => handleServerDisplay(servers), 100)
		return true
	})

	async function createIPQualityReport(server, info, emitter, contentContainer, element, exchangeRateMap) {
		const { createApp, ref, computed } = Vue
		const app = createApp({
			setup() {
				// è½¬æ¢ä¸ºå“åº”å¼å¯¹è±¡
				const serverRef = ref(server)
				const infoRef = ref(info)
				return {
					server: serverRef,
					info: infoRef
				}
			}
		})
		window.registerServerDetailPanelComponent?.(app, element, emitter)
		window.registerIPQualityComponent?.(app, element, emitter)
		window.registerLatencyMonitorComponent?.(app, element, emitter)
		window.registerBillingComponent?.(app, element, emitter, exchangeRateMap)
		app.mount(contentContainer)
	}

	// ä¿å­˜ä¸Šæ¬¡æœåŠ¡å™¨åˆ—è¡¨
	let oldLastServers = []
	async function handleServerDisplay(servers) {
		// å¦‚æœæœåŠ¡å™¨åˆ—è¡¨æ²¡æœ‰å˜åŒ–ï¼Œåˆ™ä¸è¿›è¡Œå¤„ç†
		if (oldLastServers.length === servers.length) {
			return
		}
		oldLastServers = servers
		// é€šè¿‡å…ƒç´ è·å–vueå®ä¾‹
		const appElement = document.querySelector('#app')
		if (!appElement || !appElement.__vue_app__) return

		const app = appElement.__vue_app__
		// æ‹¿åˆ° vue router çš„ route name
		const routeName = app.config.globalProperties.$route.name
		// å¦‚æœ route name ä¸æ˜¯ Homeï¼Œåˆ™ä¸è¿›è¡Œå¤„ç†
		if (routeName !== 'Home') {
			return
		}
		const emitter = {
			events: {},
			on(type, key, handle) {
				if (!emitter.events[type]) {
					emitter.events[type] = {}
				}
				emitter.events[type][key + ''] = handle
			},
			emit(type, args) {
				if (!emitter.events[type]) {
					return
				}
				for (const key in emitter.events[type]) {
					try {
						emitter.events[type][key](args)
					} catch {
					}
				}
			}
		}
		// ä» store é‡Œæ‹¿åˆ°æœåŠ¡å™¨åˆ—è¡¨
		const serverList = app.config.globalProperties.$store._state.data.serverList
		// è·å–æœåŠ¡å™¨å…ƒç´ åˆ—è¡¨
		const serverElements = document.querySelectorAll('div.server-list-container.server-list--card > div.server-list-item')
		// è·å–æ±‡ç‡
		const exchangeRateMap = await getExchangeRateMap()
		// éå†æœåŠ¡å™¨å…ƒç´ åˆ—è¡¨
		for (let index = 0; index < serverElements.length; index++) {
			// æ‹¿åˆ°æœåŠ¡å™¨å…ƒç´ 
			const element = serverElements[index]
			// å¦‚æœæœåŠ¡å™¨åˆ—è¡¨ä¸­æ²¡æœ‰è¿™ä¸ªæœåŠ¡å™¨ï¼Œåˆ™ä¸è¿›è¡Œå¤„ç†
			if (!serverList[index]) continue

			// æ‹¿åˆ°æœåŠ¡å™¨
			const server = serverList[index]
			// æ‹¿åˆ°æœåŠ¡å™¨ä¿¡æ¯
			const info = window.__ServerInfo.find(s => s.id === server.ID)
			// å¦‚æœæœåŠ¡å™¨ä¿¡æ¯ä¸ºç©ºï¼Œåˆ™ä¸è¿›è¡Œå¤„ç†
			if (!info) continue
			// å…ˆç§»é™¤å·²å­˜åœ¨çš„è‡ªå®šä¹‰å†…å®¹
			const existingContent = element.querySelector('.custom-server-display')
			if (existingContent && existingContent.parentElement) {
				existingContent.parentElement.remove()
			} else {
				// æ›¿æ¢æ•´ä¸ªè®¡è´¹ä¿¡æ¯æ˜¾ç¤ºå—
				const billingBlock = element.querySelector('.server-list-item-bill')
				billingBlock && billingBlock.remove()
			}
			// ä¿®æ”¹CPUã€å†…å­˜ã€ç£ç›˜æ˜¾ç¤º
			const coreMemGroup = element.querySelector('.cpu-mem-group')
			if (coreMemGroup) {
				const match = coreMemGroup.innerText.match(/(\d+(?:\.\d+)?)C(\d+(?:\.\d+)?)G(\d+(?:\.\d+)?)G/)
				if (match) {
					const CPU = parseFloat(match[1])
					const Mem = parseFloat(match[2])
					const Disk = parseFloat(match[3])
					coreMemGroup.innerHTML = ''
					const cpuMemGroup = document.createElement('div')
					cpuMemGroup.className = 'custom-server-header-group flex items-center gap-2 text-white'
					cpuMemGroup.innerHTML = `
					<div class="flex items-center gap-1 px-2 py-1 rounded-lg bg-gradient-to-r from-blue-600/70 to-blue-500/50 hover:from-blue-500/80 hover:to-blue-400/60 transition-all duration-200 border border-white/10 shadow-sm shadow-black/20 group">
						<i class="ri-cpu-line text-white"></i>
						<span class="font-semibold">${CPU}<span class="text-xs ml-0.5 opacity-80">æ ¸</span></span>
					</div>
					<div class="flex items-center gap-1 px-2 py-1 rounded-lg bg-gradient-to-r from-green-600/70 to-green-500/50 hover:from-green-500/80 hover:to-green-400/60 transition-all duration-200 border border-white/10 shadow-sm shadow-black/20 group">
						<i class="ri-ram-fill text-white"></i>
						<span class="font-semibold">${Mem}<span class="text-xs ml-0.5 opacity-80">G</span></span>
					</div>
					<div class="flex items-center gap-1 px-2 py-1 rounded-lg bg-gradient-to-r from-purple-600/70 to-purple-500/50 hover:from-purple-500/80 hover:to-purple-400/60 transition-all duration-200 border border-white/10 shadow-sm shadow-black/20 group">
						<i class="ri-hard-drive-3-fill text-white"></i>
						<span class="font-semibold">${Disk}<span class="text-xs ml-0.5 opacity-80">G</span></span>
					</div>`
					coreMemGroup.appendChild(cpuMemGroup)
				}
			}
			// åˆ›å»ºè‡ªå®šä¹‰å†…å®¹å®¹å™¨
			const contentContainer = document.createElement('div')
			contentContainer.className = 'custom-server-display w-full'
			contentContainer.innerHTML = document.getElementById('custom-server-display-template').innerHTML
			// å°†è‡ªå®šä¹‰å†…å®¹å®¹å™¨æ·»åŠ åˆ°æœåŠ¡å™¨å…ƒç´ å°¾éƒ¨
			element.appendChild(contentContainer)
			try {
				// æ›´æ–°æœåŠ¡å™¨è¯¦æƒ…
				createIPQualityReport(server, info, emitter, contentContainer, element, exchangeRateMap)
			} catch (e) {
				console.error('Failed to create IP quality report:', e)
			}
		}
	}

	async function getExchangeRateMap() {
		try {
			const res = await fetch('https://latest.currency-api.pages.dev/v1/currencies/usd.json')
			if (res.ok) {
				return (await res.json()).usd
			}
		} catch { }
		return undefined
	}
</script>

<style>
	.server-list-container {
		--list-item-num: 2 !important;
	}

	.max-w-5xl {
		max-width: 1440px !important;
	}

	table tbody .max-w-24 {
		max-width: none !important;
	}

	/* .world-map-group--light-background {
		background: none !important;
	} */

	.server-info-box {
		display: flex !important;
		flex-direction: row !important;
		flex-wrap: wrap !important;
		gap: 10px !important;
		justify-content: space-between !important;
	}

	.server-info-group {
		width: 45% !important;
	}

	.server-list-item-head {
		width: 100% !important;
	}

	.server-info-tag-list {
		flex-wrap: wrap;
	}

	::-webkit-scrollbar {
		width: 6px;
	}

	::-webkit-scrollbar:horizontal {
		height: 6px;
	}

	::-webkit-scrollbar-track {
		border-radius: 10px;
	}

	::-webkit-scrollbar-thumb {
		background-color: #fff3;
		border-radius: 10px;
		transition: all 0.2s ease-in-out;
	}

	::-webkit-scrollbar-thumb:hover {
		cursor: pointer;
		background-color: #fff6;
	}

	.dot-dot-box {
		background-color: #000c !important;
	}
</style>